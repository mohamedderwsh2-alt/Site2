// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum DepositStatus {
  PENDING
  CONFIRMED
  REJECTED
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

enum CommissionType {
  DEPOSIT_BONUS
  PROFIT_SHARE
}

enum EarningSource {
  TRADE
  REFERRAL
}

model User {
  id                String               @id @default(cuid())
  name              String?
  email             String?              @unique
  emailVerified     DateTime?
  passwordHash      String
  image             String?
  language          String               @default("en")
  role              UserRole             @default(USER)
  referralCode      String               @unique
  referredById      String?
  balance           Decimal              @default(0)
  availableBalance  Decimal              @default(0)
  totalDeposited    Decimal              @default(0)
  totalProfit       Decimal              @default(0)
  totalWithdrawn    Decimal              @default(0)
  referralEarnings  Decimal              @default(0)
  lastTradeAt       DateTime?
  tradeCyclesRun    Int                  @default(0)
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  referredBy        User?                @relation("UserReferrals", fields: [referredById], references: [id])
  referrals         User[]               @relation("UserReferrals")
  accounts          Account[]
  sessions          Session[]
  deposits          Deposit[]
  withdrawals       Withdrawal[]
  trades            Trade[]
  earningLogs       EarningLog[]
  referralComms     ReferralCommission[] @relation("ReferralEarner")
  referralSourceCom ReferralCommission[] @relation("ReferralSource")
  depositApprovals  Deposit[]            @relation("DepositConfirmedBy")
  withdrawalActions Withdrawal[]         @relation("WithdrawalProcessedBy")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Deposit {
  id            String         @id @default(cuid())
  userId        String
  amount        Decimal
  txHash        String?
  status        DepositStatus  @default(PENDING)
  createdAt     DateTime       @default(now())
  confirmedAt   DateTime?
  confirmedById String?
  note          String?

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  confirmedBy   User?          @relation("DepositConfirmedBy", fields: [confirmedById], references: [id])
}

model Withdrawal {
  id            String           @id @default(cuid())
  userId        String
  amount        Decimal
  address       String
  status        WithdrawalStatus @default(PENDING)
  createdAt     DateTime         @default(now())
  processedAt   DateTime?
  processedById String?
  note          String?

  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  processedBy   User?            @relation("WithdrawalProcessedBy", fields: [processedById], references: [id])
}

model Trade {
  id           String    @id @default(cuid())
  userId       String
  cycleIndex   Int
  executedAt   DateTime
  tradeAmount  Decimal
  profit       Decimal
  createdAt    DateTime  @default(now())

  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ReferralCommission {
  id           String          @id @default(cuid())
  earnerId     String
  sourceUserId String
  type         CommissionType
  amount       Decimal
  createdAt    DateTime        @default(now())

  earner       User            @relation("ReferralEarner", fields: [earnerId], references: [id], onDelete: Cascade)
  sourceUser   User            @relation("ReferralSource", fields: [sourceUserId], references: [id], onDelete: Cascade)
}

model EarningLog {
  id        String        @id @default(cuid())
  userId    String
  amount    Decimal
  source    EarningSource
  note      String?
  createdAt DateTime      @default(now())

  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
